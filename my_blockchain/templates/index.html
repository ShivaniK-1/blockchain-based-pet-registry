<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Blockchain Frontend</title>

    <link rel="stylesheet" href="/static/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/vendor/DataTables/css/datatables.min.css">
    <link rel="stylesheet" href="/static/vendor/font-awesome/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/custom.css">
    
    <!-- ==================== NEW FEATURE START: Custom Styles ==================== -->
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stats-card h3 {
            font-size: 2.5rem;
            margin: 0;
        }
        .stats-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        .mining-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .mining-status.active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        .alert-success-custom {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
    <!-- ==================== NEW FEATURE END ==================== -->
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a href="#" class="navbar-brand">Blockchain Frontend</a>

            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item active">
                        <a href="/" class="nav-link">Home</a>
                    </li>
                    <li class="nav-item">
                        <a href="/configure" class="nav-link">Configure</a>
                    </li>
                    <!-- ==================== NEW FEATURE START: New Menu Items ==================== -->
                    <li class="nav-item">
                        <a href="#" id="stats-link" class="nav-link">Statistics</a>
                    </li>
                    <!-- ==================== NEW FEATURE END ==================== -->
                </ul>
            </div>
        </div>
    </nav>

    <!-- ==================== NEW FEATURE START: Statistics Dashboard ==================== -->
    <div class="container" style="margin-top: 80px;">
        <div class="row">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <h3 id="total-blocks">0</h3>
                    <p>Total Blocks</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3 id="total-transactions">0</h3>
                    <p>Total Transactions</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h3 id="pending-transactions">0</h3>
                    <p>Pending Transactions</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <h3 id="network-nodes">0</h3>
                    <p>Network Nodes</p>
                </div>
            </div>
        </div>
    </div>
    <!-- ==================== NEW FEATURE END ==================== -->

    <!-- ==================== NEW FEATURE START: Mining Status ==================== -->
    <div class="container">
        <div id="mining-status" class="mining-status">
            <strong>Mining in progress...</strong>
            <div class="progress" style="margin-top: 10px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
        </div>
    </div>
    <!-- ==================== NEW FEATURE END ==================== -->

    <div class="container">
        <div class="row">
            <div class="col-lg-12 text-center">
                <div class="card-body">
                    <h4 class="card-title">Transactions to be added to the next block</h4>
                    <button type="submit" id="refresh_transactions" class="btn btn-primary">
                        <i class="fa fa-refresh"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <table id="unmined_transactions_table" class="table table-bordered" cellspacing="0" width="100%">
        </table>

        <div class="col-lg-12 text-center">
            <input type="button" id="mine_button" class="btn btn-primary btn-lg" value="⛏ Mine Block">
        </div>
    </div>

    <!-- ==================== NEW FEATURE START: Last Mining Result ==================== -->
    <div class="container" id="last-mining-result" style="display: none; margin-top: 20px;">
        <div class="alert-success-custom">
            <h5>✓ Block Mined Successfully!</h5>
            <p><strong>Block Number:</strong> <span id="mined-block-number"></span></p>
            <p><strong>Mining Time:</strong> <span id="mining-time"></span> seconds</p>
            <p><strong>Hash Rate:</strong> <span id="hash-rate"></span> hashes/second</p>
            <p><strong>Nonce:</strong> <span id="nonce-value"></span></p>
            <p><strong>Merkle Root:</strong> <span id="merkle-root" style="font-family: monospace; font-size: 0.9em;"></span></p>
        </div>
    </div>
    <!-- ==================== NEW FEATURE END ==================== -->

    <div class="container">
        <div class="row">
            <div class="col-lg-12 text-center">
                <div class="card-body">
                    <h4 class="card-title">Transactions on the blockchain</h4>
                    <button type="submit" id="refresh_blockchain" class="btn btn-primary">
                        <i class="fa fa-refresh"></i> Sync with Network
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <table id="transactions_table" class="table table-bordered" cellspacing="0" width="100%">
        </table>
    </div>

        <script src="/static/vendor/jquery/jquery.min.js"></script>
    <script src="/static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/static/vendor/DataTables/js/datatables.min.js"></script>
    <script src="/static/vendor/DataTables/js/ellipsis.js"></script>

    <script>
        // ==================== NEW FEATURE START: Load Statistics ==================== 
        function loadStatistics() {
            $.ajax({
                url: "/stats",
                type: "GET",
                success: function(response) {
                    $('#total-blocks').text(response.total_blocks);
                    $('#total-transactions').text(response.total_transactions);
                    $('#pending-transactions').text(response.pending_transactions);
                    $('#network-nodes').text(response.total_nodes);
                },
                error: function(error) {
                    console.log("Could not load statistics:", error);
                }
            });
        }

        // Load statistics on page load and refresh every 10 seconds
        loadStatistics();
        setInterval(loadStatistics, 10000);
        // ==================== NEW FEATURE END ====================

        // Helper: normalize any transaction object into a flat row
        function normalizeTransaction(tx, blockNumber, idx) {
            // type
            const type = tx.type || (tx.sender_public_key ? "TRANSFER" : "SYSTEM");

            // pet info
            const petId   = tx.pet_id   || "";
            const petName = tx.pet_name || "";

            // actor fields – pick best-guess "from" and "to"
            const from =
                tx.sender_public_key ||
                tx.owner_public_key ||
                tx.viewer_public_key ||
                tx.finder_public_key ||
                "";

            const to = tx.recipient_public_key || "";

            // amount (may not exist for pet events)
            const amount = (tx.amount !== undefined && tx.amount !== null) ? tx.amount : "";

            // timestamp (seconds → ms)
            let formattedTimestamp = "";
            if (tx.timestamp) {
                const options = {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit"
                };
                const date = new Date(tx.timestamp * 1000);
                formattedTimestamp = date.toLocaleTimeString("en-US", options);
            }

            return [
                idx,                 // #
                type,                // Type
                petId,               // Pet ID
                petName,             // Pet Name
                from,                // From (Actor)
                to,                  // To
                amount,              // Amount
                formattedTimestamp,  // Timestamp
                blockNumber || ""    // Block#
            ];
        }

        $(function() {
            // ==================== MINED TRANSACTIONS TABLE ====================
            $.ajax({
                url: "/chain",
                type: "GET",
                success: function(response) {
                    const transactions = [];
                    let count = 1;

                    for (let i = 0; i < response.length; i++) {
                        const block = response.chain[i];
                        const blockNumber = block.block_number;
                        const blockTxs = block.transactions || [];

                        for (let j = 0; j < blockTxs.length; j++) {
                            const row = normalizeTransaction(blockTxs[j], blockNumber, count);
                            transactions.push(row);
                            count += 1;
                        }
                    }

                    $('#transactions_table').DataTable({
                        data: transactions,
                        columns: [
                            { title: "#" },
                            { title: "Type" },
                            { title: "Pet ID" },
                            { title: "Pet Name" },
                            { title: "From (Actor)" },
                            { title: "To" },
                            { title: "Amount" },
                            { title: "Timestamp" },
                            { title: "Block#" }
                        ],
                        columnDefs: [
                            { targets: [2,3,4,5,7], render: $.fn.dataTable.render.ellipsis(25) }
                        ]
                    });
                },
                error: function(error) {
                    console.log(error);
                }
            });

            // ==================== UNMINED / PENDING TRANSACTIONS TABLE ====================
            $.ajax({
                url: "/transactions/get",
                type: "GET",
                success: function(response) {
                    const transactions = [];
                    let count = 1;

                    const pending = response.transactions || [];

                    for (let i = 0; i < pending.length; i++) {
                        const tx = pending[i];
                        // For pending transactions, blockNumber is not set yet
                        const row = normalizeTransaction(tx, "", count);
                        transactions.push(row);
                        count += 1;
                    }

                    $('#unmined_transactions_table').DataTable({
                        data: transactions,
                        columns: [
                            { title: "#" },
                            { title: "Type" },
                            { title: "Pet ID" },
                            { title: "Pet Name" },
                            { title: "From (Actor)" },
                            { title: "To" },
                            { title: "Amount" },
                            { title: "Timestamp" }
                        ],
                        columnDefs: [
                            { targets: [2,3,4,5,7], render: $.fn.dataTable.render.ellipsis(25) }
                        ]
                    });
                },
                error: function(error) {
                    console.log(error);
                }
            });

            // ==================== NEW FEATURE START: Enhanced Mining with Status ====================
            $('#mine_button').click(function() {
                $('#mining-status').addClass('active');
                $('#mine_button').prop('disabled', true);
                
                $.ajax({
                    url: '/mine',
                    type: 'GET',
                    success: function(response) {
                        $('#mining-status').removeClass('active');
                        $('#mine_button').prop('disabled', false);
                        
                        $('#mined-block-number').text(response.block_number || response.block?.block_number || "");
                        $('#mining-time').text(response.mining_time || "");
                        $('#hash-rate').text(response.hash_rate || "");
                        $('#nonce-value').text(response.nonce || response.block?.nonce || "");
                        $('#merkle-root').text(response.merkle_root || "");
                        $('#last-mining-result').show();
                        
                        loadStatistics();
                        
                        setTimeout(function() {
                            window.location.reload();
                        }, 3000);
                    },
                    error: function(error) {
                        console.log(error);
                        $('#mining-status').removeClass('active');
                        $('#mine_button').prop('disabled', false);
                        alert('Mining failed. Please try again.');
                    }
                });
            });
            // ==================== NEW FEATURE END ====================

            $('#refresh_transactions').click(function() {
                window.location.reload();
            });

            $('#refresh_blockchain').click(function() {
                $.ajax({
                    url: '/nodes/resolve',
                    type: 'GET',
                    success: function(response) {
                        alert(response.message);
                        window.location.reload();
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
            });

            // ==================== NEW FEATURE START: Statistics Modal ====================
            $('#stats-link').click(function(e) {
                e.preventDefault();
                $.ajax({
                    url: "/stats",
                    type: "GET",
                    success: function(response) {
                        let statsHTML = `
                            <div class="modal fade" id="statsModal" tabindex="-1" role="dialog">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Blockchain Statistics</h5>
                                            <button type="button" class="close" data-dismiss="modal">
                                                <span>&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <table class="table">
                                                <tr><td><strong>Total Blocks:</strong></td><td>${response.total_blocks}</td></tr>
                                                <tr><td><strong>Total Transactions:</strong></td><td>${response.total_transactions}</td></tr>
                                                <tr><td><strong>Pending Transactions:</strong></td><td>${response.pending_transactions}</td></tr>
                                                <tr><td><strong>Avg Transactions/Block:</strong></td><td>${response.avg_transactions_per_block}</td></tr>
                                                <tr><td><strong>Network Nodes:</strong></td><td>${response.total_nodes}</td></tr>
                                                <tr><td><strong>Mining Difficulty:</strong></td><td>${response.difficulty}</td></tr>
                                                <tr><td><strong>Mining Reward:</strong></td><td>${response.mining_reward}</td></tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        $('body').append(statsHTML);
                        $('#statsModal').modal('show');
                        $('#statsModal').on('hidden.bs.modal', function () {
                            $(this).remove();
                        });
                    }
                });
            });
            // ==================== NEW FEATURE END ====================
        });
    </script>
</body>
</html>
